#Verify that the script is running with administrative privileges
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "This script must be run as administrator." -ForegroundColor Red
    $ElevatedProcess = New-Object System.Diagnostics.ProcessStartInfo "PowerShell"
    $ElevatedProcess.Arguments = "& '" + $script:MyInvocation.MyCommand.Path + "'"
    $ElevatedProcess.Verb = "runas"
    try {
    	[System.Diagnostics.Process]::Start($ElevatedProcess)
        Read-Host "wait"
    	
    }catch{
     Write-Host "An error occurred: $_" -ForegroundColor Red
    }
}

#Prompt the user to enter a username
$userName = Read-Host "Please enter the username for the profile reset: "

#Verify whether the session of the provided username is active
$sessionInfo = quser | Select-String $userName
if ($sessionInfo) {
    # Extract the user's session ID
    $sessionID = ($sessionInfo -split "\s+")[2]  # The third element is usually the session ID
    Write-Host "The user $userName is currently logged in (Session ID: $sessionID). Logging off..." -ForegroundColor Yellow

    logoff $sessionID
    Start-Sleep -Seconds 3

#Final check that the session has been properly closed
    $sessionInfo = quser | Select-String $userName
    if ($sessionInfo) {
        Write-Host "Unable to log off user $userName. Deletion canceled." -ForegroundColor Red
        exit
    } else {
        Write-Host "User $userName has been successfully logged off." -ForegroundColor Green
    }
} else {
    Write-Host "User $userName is not logged in." -ForegroundColor Green
}

#Delete the username from the Registry
$profileListPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList"
$profileKey = Get-ChildItem $profileListPath | Where-Object {
    $profilePath = (Get-ItemProperty $_.PSPath).ProfileImagePath
    $profilePath -like "*$userName"
}

if ($profileKey) {
    Remove-Item -Path $profileKey.PSPath -Recurse -Force
    Write-Host "User $userName has been removed from the registry." -ForegroundColor Green
} else {
    Write-Host "User $userName not found in the registry." -ForegroundColor Yellow
}

#Rename the user's folder to .old
$profileFolder = "C:\Users\$userName"
$profileFolderOld = "C:\Users\$userName.old"

if (Test-Path $profileFolder) {
    Rename-Item -Path $profileFolder -NewName $profileFolderOld
    Write-Host "The user profile folder $userName has been renamed to $userName.old." -ForegroundColor Green
} else {
    Write-Host "The profile folder $userName was not found." -ForegroundColor Yellow
}

Write-Host "Profile reset completed successfully!"
$confirmation = Read-Host "Press Enter to exit."

if ($confirmation -eq 'exit' -or $confirmation -eq '') {

    exit

} else {

    Write-Host "Please press Enter to exit!"
    Read-Host "Press Enter."
}
